<!doctype html>
<meta charset=utf-8>
<title>HTML Editing Commands</title>
<link rel=stylesheet href=http://www.whatwg.org/style/specification>
<style>
 pre, code { font-family:monospace, sans-serif; }
 h2 code, h3 code, h4 code,
 h2 :link, h3 :link, h4 :link,
 h2 :visited, h3 :visited, h4 :visited
 { font:inherit; color:inherit; font-style:italic; }
 @media print {
   :not([data-anolis-spec]) > [data-anolis-spec]::after {
     content: "[" attr(data-anolis-spec) "]";
     font-size: 0.6em;
     vertical-align: super;
     text-transform: uppercase;
   }
 }
</style>
<body class=draft>
<div class=head id=head>
<h1>HTML Editing Commands</h1>
<h2 class="no-num no-toc">Work in Progress &mdash; Last Update [DATE: 01 Jan 1901]</h2>
<dl>
 <dt>Editor
 <dd>Aryeh Gregor &lt;ayg+spec@aryeh.name>

 <dt>Version history
 <dd><a href=http://aryeh.name/gitweb.cgi?p=editcommands>http://aryeh.name/gitweb.cgi?p=editcommands</a>
</dl>
</div>


<h2 class=no-num>Table of contents</h2>
<!--toc-->


<h2>Introduction</h2>
<p>This specification defines commands to edit HTML documents programmatically.
The APIs specified here were originally introduced in Microsoft's Internet
Explorer, but have subsequently been copied by other browsers in a haphazard
and imprecise fashion.  Although the behavior specified here does not exactly
match any browser at the time of writing, it can serve as a target to converge
to in the future.

<p>Where the reasoning behind the specification is of interest, such as when
major preexisting rendering engines are known not to match it, the reasoning is
included in HTML comments so as not to distract the reader.


<h2>Definitions</h2>
<p>When a user agent is to <dfn title=split-text-node>split a <code
data-anolis-spec=domcore>Text</code> node</dfn> <var title>node</var>, it must
run the following steps:

<ol>
  <li>Let <var title>prefix</var> be the substring of <var title>node</var>'s
  <code data-anolis-spec=domcore title=dom-CharacterData-data>data</code>
  of length <var title>offset</var> beginning at offset 0.

  <li>Let <var title>prefix node</var> be a new <code
  data-anolis-spec=domcore>Text</code> node whose <code
  data-anolis-spec=domcore title=dom-CharacterData-data>data</code> is equal to
  <var title>prefix</var> and whose <code data-anolis-spec=domcore
  title=dom-Node-ownerDocument>ownerDocument</code> is equal to <var
  title>node</var>'s.
  
  <li>Insert <var title>prefix node</var> in <var title>node</var>'s parent as
  the previous sibling of <var title>node</var>.

  <li>Let <var title>suffix</var> be the substring of <var title>node</var>'s
  <code data-anolis-spec=domcore title=dom-CharacterData-data>data</code>
  beginning at offset <var title>offset</var> and continuing to the end of the
  string.

  <li>Let <var title>suffix node</var> be a new <code
  data-anolis-spec=domcore>Text</code> node whose <code
  data-anolis-spec=domcore title=dom-CharacterData-data>data</code> is equal to
  <var title>suffix</var> and whose <code data-anolis-spec=domcore
  title=dom-Node-ownerDocument>ownerDocument</code> is equal to <var
  title>node</var>'s.
  
  <li>Insert <var title>suffix node</var> in <var title>node</var>'s parent as
  the previous sibling of <var title>node</var>.

  <li>Delete <var title>node</var> from its parent.

  <li>Return (<var title>prefix node</var>, <var title>suffix node</var>).
</ol>

<p>When a user agent is to <dfn title=wrap-range-in-tag>wrap a <code
data-anolis-spec=domrange>Range</code> <var title>range</var> in a tag <var
title>tag</var></dfn>, it must run the following steps:

<p class=XXX>This is totally made up and I have no idea yet if it matches
browsers and/or is even vaguely coherent.

<ol>
  <li>Let <var title>start node</var>, <var title>start offset</var>, <var
  title>end node</var>, and <var title>end offset</var> be the <span
  data-anolis-spec=domrange title=concept-range-start>start</span> and <span
  data-anolis-spec=domrange title=concept-range-end>end</span> <span
  data-anolis-spec=domrange title=concept-boundary-point-node>nodes</span> and
  <span data-anolis-spec=domrange
  title=concept-boundary-point-offset>offsets</span> of <var title>range</var>,
  respectively.

  <li>Let <var title>document</var> be the <code data-anolis-spec=domcore
  title=dom-Node-ownerDocument>ownerDocument</code> of <var title>start
  node</var>.

  <li>If <var title>start node</var> is a <code
  data-anolis-spec=domcore>Text</code>, <code
  data-anolis-spec=domcore>ProcessingInstruction</code>, or <code
  data-anolis-spec=domcore>Comment</code>, and it has no parent, abort these
  steps.

  <p class=XXX>Figure out something sensible here.  Doesn't make sense except
  in IE, since other browsers fail if it's not contentEditable.  What does IE
  do?  What do we expect?

  <li>If <var title>start node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>start offset</var>
  is neither 0 nor the <span data-anolis-spec=domrange
  title=concept-node-length>length</span> of <var title>start node</var>, <span
  title=split-text-node>split <var title>start node</var></span> and set <var
  title>start node</var> to the second returned node.  Set <var title>start
  offset</var> to 0.

  <li>If <var title>start node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>start offset</var>
  is 0, set <var title>start offset</var> to the <span
  data-anolis-spec=domrange title=concept-indexof>index of</span> <var
  title>start node</var> in its parent, then set <var title>start node</var> to
  its parent.

  <li>If <var title>start node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>start offset</var>
  is the <span data-anolis-spec=domrange
  title=concept-node-length>length</span> of <var title>start node</var>, or if
  <var title>start node</var> is a <code
  data-anolis-spec=domcore>Comment</code> or <code
  data-anolis-spec=domcore>ProcessingInstruction</code>, set <var title>start
  offset</var> to one plus the <span data-anolis-spec=domrange
  title=concept-indexof>index of</span> <var title>start node</var> in its
  parent, then set <var title>start node</var> to its parent.

  <li>If <var title>end node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>end offset</var> is
  neither 0 nor the <span data-anolis-spec=domrange
  title=concept-node-length>length</span> of <var title>end node</var>, <span
  title=split-text-node>split <var title>end node</var></span> and set <var
  title>end node</var> to the first returned node.  Set <var title>end
  offset</var> to the <span data-anolis-spec=domrange
  title=concept-node-length>length</span> of the new <var title>end node</var>.

  <li>If <var title>end node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>end offset</var> is
  the <span data-anolis-spec=domrange title=concept-node-length>length</span>
  of <var title>end node</var>, set <var title>end offset</var> to one plus the
  <span data-anolis-spec=domrange title=concept-indexof>index of</span> <var
  title>end node</var> in its parent, then set <var title>end node</var> to its
  parent.

  <li>If <var title>end node</var> is a <code
  data-anolis-spec=domcore>Text</code> node and <var title>end offset</var> is
  0, or if <var title>end node</var> is a <code
  data-anolis-spec=domcore>Comment</code> or <code
  data-anolis-spec=domcore>ProcessingInstruction</code>, set <var title>end
  offset</var> to the <span data-anolis-spec=domrange
  title=concept-indexof>index of</span> <var title>end node</var> in its
  parent, then set <var title>end node</var> to its parent.

  <p class=note>The previous several steps have ensured that <var title>start
  node</var> and <var title>end node</var> are not <code
  data-anolis-spec=domcore>Text</code>, <code
  data-anolis-spec=domcore>Comment</code>, or <code
  data-anolis-spec=domcore>ProcessingInstruction</code> nodes, so <var
  title>start offset</var> and <var title>end offset</var> now represent node
  offsets instead of character offsets.

  <li>Let <var title>node</var> equal <var title>start node</var> and let <var
  title>offset</var> equal <var title>start offset</var>.

  <li>Repeat the following steps until aborted:
  <ol>
	<li><i title id=wrap-algorithm-start>Start</i>: If <var title>node</var> is
	after <var title>end node</var> in <span data-anolis-spec=domcore>tree
	order</span>, or if <var title>node</var> equals <var title>end node</var>
	and <var title>offset</var> is greater than or equal to <var title>end
	offset</var>, abort this subalgorithm.

    <li>Let <var title>element</var> be a new <code
	data-anolis-spec=domcore>Element</code> with no attributes, <span
	data-anolis-spec=domcore title=concept-element-namespace>namespace</span>
	set to the <span data-anolis-spec=domcore>HTML namespace</span>, <span
	data-anolis-spec=domcore title=concept-element-local-name>local name</span>
	set to <var title>tag</var>, and <code data-anolis-spec=domcore
	title=dom-Node-ownerDocument>ownerDocument</code> set to <var
	title>document</var>.

	<li>While <var title>node</var> has a child with <span
	data-anolis-spec=domrange title=concept-indexof>index</span> <var
	title>offset</var>, and that child is a <code
	data-anolis-spec=domcore>Text</code> node whose <code
	data-anolis-spec=domcore title=dom-CharacterData-data>data</code> is only
	<span data-anolis-spec=html title="space character">space characters</span>
	or that child is a <code data-anolis-spec=domcore>Comment</code> or that
	child is a <code data-anolis-spec=domcore>ProcessingInstruction</code>,
	increment <var title>offset</var>.
	<!-- This avoids wrapping whitespace-only text nodes, which agrees with
	WebKit.  IE9 wraps the whitespace-only text nodes, and Gecko tries to do
	something crazy like add CSS attributes instead of elements. -->

	<li>If <var title>offset</var> is equal to <var title>node</var>'s number
	of children, let <var title>node</var> equal the first <code
	data-anolis-spec=domcore>Node</code> in <var title>document</var> that is
	after all of <var title>node</var>'s <span data-anolis-spec=domcore
	title=concept-descendant-node>descendants</span> in <span
	data-anolis-spec=domcore>tree order</span>, and let <var title>offset</var>
	equal zero.  Continue from <i title><a
	href=#wrap-algorithm-start>start</a></i>.

	<li>Let <var title>child</var> be the child of <var title>node</var> with
	<span data-anolis-spec=domrange title=concept-indexof>index</span> <var
	title>offset</var>.

	<li>If <var title>child</var> is an <code
	data-anolis-spec=domcore>Element</code> which is not part of the <span
	data-anolis-spec=html title="content models">content model</span> of <var
	title>element</var>:
	
	<ol>
	  <li>Create a new <code data-anolis-spec=domrange>Range</code> with <span
	  data-anolis-spec=domrange title=concept-range-start>start</span> (<var
	  title>child</var>, 0), <span data-anolis-spec=domrange
	  title=concept-range-end>end</span> (<var title>child</var>, <span
	  data-anolis-spec=domrange title=concept-node-length>length</span> of <Var
	  title>child</var>), and <span data-anolis-spec=domrange
	  title=concept-range-root>root</span> the same as <var title>range</var>'s
	  <span data-anolis-spec=domrange title=concept-range-root>root</span>.
      
	  <li><span title=wrap-range-in-tag>Wrap that <code
	  data-anolis-spec=domrange>Range</code> in <var title>tag</var></span>.

	  <li>Increment <var title>offset</var>.

	  <li>Continue from <i title><a href=#wrap-algorithm-start>start</a></i>.
	</ol>

	<li>Append <var title>element</var> to <var title>node</var> as the
	previous sibling of <var title>child</var>.

	<li>While the child of <var title>node</var> has a child with <span
	data-anolis-spec=domrange title=concept-indexof>index</span> <var
	title>offset</var>, and while that child is not an <code
	data-anolis-spec=domcore>Element</code> or is an <code
	data-anolis-spec=domcore>Element</code> but is part of the <span
	data-anolis-spec=html title="content models">content model</span> of <var
	title>element</var>, change that child's parent to <var title>element</var>
	and increment <var title>offset</var>.

	<p class=XXX>What exactly does it mean to change the child's parent?  E.g.,
	what happens if this occurs to a video that's playing?  Is there a precise
	spec somewhere?
  </ol>
</ol>


<h2>Commands</h2>
<dl>
<dt><code title><dfn title=command-bold>bold</dfn></code>
<dd>The user agent must <span title=wrap-range-in-tag>wrap each <code
data-anolis-spec=domrange>Range</code></span> of the current <code
data-anolis-spec=domrange>Selection</code> in a "b" tag.

<p class=XXX>Be clearer.  What's the "current Selection", and what does it mean
to wrap "each Range"?  What if there are overlapping Ranges?
</dl>


<h2 class=no-num id=references>References</h2><!--REFS-->
<p>All references are normative unless marked "Non-normative".</p>
<div id=anolis-references></div>


<!--
<h2 class=no-num>Acknowledgements</h2>
<p>...
-->
<script src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>
